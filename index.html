<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My DVD Collection (Debug Mode)</title>
<style>
  /* Same styling as before */
  body {
    margin: 0; font-family: Arial, sans-serif; background: #111; color: #eee;
    transition: background 0.3s, color 0.3s;
  }
  .dark-mode {
    background: #222; color: #eee;
  }
  header {
    padding: 1em;
    background: #222;
    display: flex; align-items: center; gap: 1em;
  }
  header input[type=search] {
    flex-grow: 1; padding: 0.5em; font-size: 1em; border-radius: 4px; border: none;
  }
  header label {
    cursor: pointer;
    user-select: none;
  }
  header label input[type=checkbox] {
    margin-right: 0.5em;
  }
  h2 {
    margin-left: 1em; font-weight: normal;
  }
  .row {
    margin: 1em 0 2em 0;
    overflow-x: auto;
    white-space: nowrap;
    padding-left: 1em;
  }
  .movie {
    display: inline-block;
    width: 140px;
    margin-right: 0.5em;
    vertical-align: top;
    cursor: pointer;
    position: relative;
  }
  .movie img {
    width: 140px;
    height: 210px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.7);
  }
  .movie-title {
    margin-top: 0.25em;
    font-size: 0.9em;
    white-space: normal;
    height: 2.6em;
    overflow: hidden;
  }
  .icon {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 18px;
    height: 18px;
    opacity: 0.8;
  }
  .icon.watched {
    filter: hue-rotate(90deg);
  }
  .icon.liked {
    filter: hue-rotate(300deg);
    right: 30px;
  }
  #modal {
    display: none;
    position: fixed;
    z-index: 2000;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.85);
    align-items: center;
    justify-content: center;
    padding: 2em;
    box-sizing: border-box;
  }
  #modal.show {
    display: flex;
  }
  #modal-content {
    background: #222;
    border-radius: 10px;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 1em 1.5em;
    color: #eee;
    box-sizing: border-box;
  }
  #modal-close {
    float: right;
    font-size: 1.5em;
    cursor: pointer;
    font-weight: bold;
    user-select: none;
  }
  #modal img {
    float: left;
    margin-right: 1em;
    width: 150px;
    height: 225px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.9);
  }
  #modal h3 {
    margin-top: 0;
  }
  #modal .info {
    font-size: 0.9em;
    margin-top: 0.5em;
    clear: both;
  }
  #modal iframe {
    width: 100%;
    height: 315px;
    margin-top: 1em;
    border: none;
    border-radius: 6px;
  }
  .row::-webkit-scrollbar {
    height: 8px;
  }
  .row::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
  }
</style>
</head>
<body>

<header>
  <input id="searchInput" type="search" placeholder="Search by title, director, actor..." />
  <label><input type="checkbox" id="darkModeToggle" /> Dark Mode</label>
</header>

<main id="content">
  <p>Loading your collection...</p>
</main>

<div id="modal" aria-hidden="true">
  <div id="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <span id="modal-close" tabindex="0" role="button" aria-label="Close modal">&times;</span>
    <h3 id="modalTitle"></h3>
    <img id="modalPoster" alt="Movie poster" />
    <div class="info" id="modalInfo"></div>
    <p id="modalDescription"></p>
    <iframe id="modalTrailer" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
  </div>
</div>

<script>
(async function(){
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQp02iy9X1EC_W7jm12Ph3G9Z28WS1ndYJr6D-MS3CfeIBPkQiFbD9ZZj_mfOHxkZXFKEQNdmQoIhG3/pub?gid=0&single=true&output=csv';

  const content = document.getElementById('content');
  const searchInput = document.getElementById('searchInput');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const modal = document.getElementById('modal');
  const modalClose = document.getElementById('modal-close');
  const modalTitle = document.getElementById('modalTitle');
  const modalPoster = document.getElementById('modalPoster');
  const modalInfo = document.getElementById('modalInfo');
  const modalDescription = document.getElementById('modalDescription');
  const modalTrailer = document.getElementById('modalTrailer');

  let movies = [];
  let filteredMovies = [];

  console.log('Starting to fetch CSV from:', CSV_URL);

  // CSV Parsing helper
  function csvToObjects(csv){
    console.log('Parsing CSV text...');
    const lines = csv.trim().split('\n');
    console.log(`Total lines in CSV: ${lines.length}`);
    const headers = lines.shift().split(',').map(h => h.trim());
    console.log('Parsed headers:', headers);
    return lines.map((line,i) => {
      const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
      if(values.length !== headers.length){
        console.warn(`Line ${i+2} values length (${values.length}) does not match headers length (${headers.length})`);
      }
      const obj = {};
      headers.forEach((h,i) => {
        let v = values[i] || '';
        if(v.startsWith('"') && v.endsWith('"')) v = v.slice(1,-1);
        obj[h] = v.trim();
      });
      return obj;
    });
  }

  // Normalize keys to safe property names (replace spaces, parentheses)
  function normalizeKeys(movies) {
    console.log('Normalizing keys...');
    return movies.map(m => {
      const norm = {};
      Object.entries(m).forEach(([k,v]) => {
        const key = k.trim().replace(/[ ()]/g,'_');
        norm[key] = v;
      });
      return norm;
    });
  }

  function groupByGenre(movieList){
    const groups = {};
    movieList.forEach(m => {
      if(!m.Genre_s) {
        console.warn('Movie missing Genre(s):', m.Title || m);
        return;
      }
      m.Genre_s.split(',').map(g=>g.trim()).forEach(genre=>{
        if(!groups[genre]) groups[genre] = [];
        groups[genre].push(m);
      });
    });
    return groups;
  }

  function getRecentlyWatched(n=5){
    console.log('Filtering recently watched movies...');
    const filtered = movies.filter(m => {
      if(!m.Watched_Yes_No){
        console.warn('Movie missing Watched_Yes_No:', m.Title || m);
        return false;
      }
      return m.Watched_Yes_No.toLowerCase() === 'yes';
    });
    filtered.sort((a,b) => {
      const da = new Date(a.Last_Watched || 0);
      const db = new Date(b.Last_Watched || 0);
      return db - da;
    });
    console.log(`Found ${filtered.length} recently watched movies.`);
    return filtered.slice(0,n);
  }

  function getRecommendations(){
    console.log('Getting recommendations...');
    const recent = getRecentlyWatched();
    if(!recent.length){
      console.log('No recent watches, skipping recommendations.');
      return [];
    }
    const genres = new Set();
    const directors = new Set();
    const actors = new Set();

    recent.forEach(m=>{
      if(m.Genre_s) m.Genre_s.split(',').forEach(g=>genres.add(g.trim()));
      if(m.Director_s) m.Director_s.split(',').forEach(d=>directors.add(d.trim()));
      if(m.Main_Actor_s) m.Main_Actor_s.split(',').forEach(a=>actors.add(a.trim()));
    });

    const recommended = movies.filter(m=>{
      if((m.Watched_Yes_No || '').toLowerCase() === 'yes') return false;
      const movieGenres = m.Genre_s ? m.Genre_s.split(',').map(x=>x.trim()) : [];
      const movieDirectors = m.Director_s ? m.Director_s.split(',').map(x=>x.trim()) : [];
      const movieActors = m.Main_Actor_s ? m.Main_Actor_s.split(',').map(x=>x.trim()) : [];
      return movieGenres.some(g=>genres.has(g)) ||
             movieDirectors.some(d=>directors.has(d)) ||
             movieActors.some(a=>actors.has(a));
    });
    console.log(`Recommended ${recommended.length} movies.`);
    return recommended;
  }

  function sortByTitle(arr){
    return arr.slice().sort((a,b)=>{
      const aT = (a.Title || '').toLowerCase();
      const bT = (b.Title || '').toLowerCase();
      return aT.localeCompare(bT);
    });
  }

  function renderRow(title, movies){
    console.log(`Rendering row: ${title} (${movies.length} movies)`);
    if(!movies.length) return null;
    const container = document.createElement('section');
    container.classList.add('row');
    const h2 = document.createElement('h2');
    h2.textContent = title;
    container.appendChild(h2);
    movies.forEach(m=>{
      const div = document.createElement('div');
      div.className = 'movie';
      div.tabIndex = 0;
      div.setAttribute('role', 'button');
      div.setAttribute('aria-label', `Details for ${m.Title || 'Untitled'}`);
      div.addEventListener('click', ()=>openModal(m));
      div.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { openModal(m); e.preventDefault(); } });

      const img = document.createElement('img');
      img.src = m.Poster || 'https://via.placeholder.com/140x210?text=No+Image';
      img.alt = m.Title || 'Untitled';

      div.appendChild(img);

      if((m.Watched_Yes_No || '').toLowerCase() === 'yes'){
        const wIcon = document.createElement('span');
        wIcon.textContent = 'âœ“';
        wIcon.title = 'Watched';
        wIcon.className = 'icon watched';
        wIcon.style.position = 'absolute';
        wIcon.style.top = '6px';
        wIcon.style.right = '6px';
        wIcon.style.color = 'limegreen';
        div.appendChild(wIcon);
      }

      const titleDiv = document.createElement('div');
      titleDiv.className = 'movie-title';
      titleDiv.textContent = m.Title || 'Untitled';
      div.appendChild(titleDiv);

      container.appendChild(div);
    });
    return container;
  }

  function openModal(m){
    console.log('Opening modal for:', m.Title || m);
    modalTitle.textContent = m.Title || 'Untitled';
    modalPoster.src = m.Poster || 'https://via.placeholder.com/150x225?text=No+Image';
    modalDescription.textContent = m.Description || '';
    modalInfo.innerHTML = `
      <strong>Genre(s):</strong> ${m.Genre_s || 'N/A'}<br/>
      <strong>Director(s):</strong> ${m.Director_s || 'N/A'}<br/>
      <strong>Main Actor(s):</strong> ${m.Main_Actor_s || 'N/A'}<br/>
      <strong>Type:</strong> ${m.Type || 'N/A'}<br/>
      <strong>DVD Title:</strong> ${m.DVD_Collection_Title || 'N/A'}<br/>
      <strong>Last Watched:</strong> ${m.Last_Watched || 'N/A'}
    `;

    if(m.Trailer){
      console.log('Loading trailer:', m.Trailer);
      let trailerSrc = '';
      const idMatch = m.Trailer.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
      if(idMatch){
        trailerSrc = `https://www.youtube-nocookie.com/embed/${idMatch[1]}?autoplay=1&modestbranding=1`;
      } else if(m.Trailer.includes('youtube.com') || m.Trailer.includes('youtu.be')){
        trailerSrc = m.Trailer;
      }
      modalTrailer.src = trailerSrc;
      modalTrailer.style.display = 'block';
    } else {
      modalTrailer.src = '';
      modalTrailer.style.display = 'none';
    }

    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    modalClose.focus();
  }

  function closeModal(){
    console.log('Closing modal');
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    modalTrailer.src = '';
  }
  modalClose.addEventListener('click', closeModal);
  modal.addEventListener('click', e => { if(e.target === modal) closeModal(); });
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape' && modal.classList.contains('show')) closeModal();
  });

  function renderAll(){
    console.log('Rendering all rows...');
    content.innerHTML = '';
    const searched = searchInput.value.trim().toLowerCase();
    filteredMovies = movies.filter(m=>{
      if(!searched) return true;
      return ['Title','Director_s','Main_Actor_s','Genre_s','DVD_Collection_Title'].some(field=>{
        return (m[field] || '').toLowerCase().includes(searched);
      });
    });

    filteredMovies = sortByTitle(filteredMovies);

    if(!searched){
      const recent = getRecentlyWatched();
      if(recent.length){
        content.appendChild(renderRow('Recently Watched', recent));
      }
      const recs = getRecommendations();
      if(recs.length){
        content.appendChild(renderRow('Recommended for You', recs));
      }
    }

    const grouped = groupByGenre(filteredMovies);
    Object.keys(grouped).sort().forEach(genre=>{
      content.appendChild(renderRow(genre, grouped[genre]));
    });

    if(content.innerHTML === ''){
      content.innerHTML = '<p>No movies match your search.</p>';
    }
  }

  function setDarkMode(on){
    console.log('Setting dark mode:', on);
    if(on) document.body.classList.add('dark-mode');
    else document.body.classList.remove('dark-mode');
    localStorage.setItem('darkMode', on ? '1' : '0');
  }

  darkModeToggle.addEventListener('change', e => {
    setDarkMode(e.target.checked);
  });

  try {
    console.log('Fetching CSV...');
    const res = await fetch(CSV_URL);
    if(!res.ok) throw new Error(`Failed to fetch CSV: ${res.status} ${res.statusText}`);
    const text = await res.text();
    console.log('CSV fetched, parsing...');
    movies = normalizeKeys(csvToObjects(text));
    console.log('Movies loaded:', movies.length);
    renderAll();
  } catch(e){
    content.innerHTML = '<p>Failed to load your collection. Check your CSV URL and internet connection.</p>';
    console.error('Error loading CSV or rendering:', e);
  }

  searchInput.addEventListener('input', () => {
    console.log('Search input changed:', searchInput.value);
    renderAll();
  });

  // Set dark mode on load from localStorage
  setDarkMode(localStorage.getItem('darkMode') === '1');

})();
</script>

</body>
</html>
