<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My DVD Library</title>
<style>
  /* Basic reset & styling */
  body {
    margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #121212; color: #eee;
    transition: background 0.3s, color 0.3s;
  }
  header {
    padding: 1rem 2rem; background: #1f1f1f; display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap;
  }
  header h1 {
    margin: 0; font-weight: 700;
  }
  .controls {
    display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;
  }
  input[type=search] {
    padding: 0.4rem 0.6rem; font-size: 1rem; border-radius: 4px; border: none;
    max-width: 250px;
  }
  button {
    background: #3a3a3a; border: none; padding: 0.5rem 1rem; border-radius: 4px; color: #eee;
    cursor: pointer; font-weight: 600;
  }
  button:hover {
    background: #555;
  }
  main {
    padding: 1rem 2rem;
    max-width: 1200px;
    margin: 0 auto 3rem;
  }
  .row-title {
    margin: 1.5rem 0 0.5rem; font-size: 1.4rem; font-weight: 700;
  }
  .carousel {
    display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.5rem;
    scroll-behavior: smooth;
  }
  .carousel::-webkit-scrollbar {
    height: 8px;
  }
  .carousel::-webkit-scrollbar-thumb {
    background: #555; border-radius: 4px;
  }
  .movie-card {
    flex: 0 0 auto; width: 150px; cursor: pointer;
    background: #222; border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.8);
    position: relative;
    transition: transform 0.15s ease-in-out;
  }
  .movie-card:hover {
    transform: scale(1.05);
    z-index: 5;
  }
  .movie-poster {
    width: 100%; height: 225px; border-radius: 6px 6px 0 0;
    object-fit: cover;
    background: #333;
  }
  .movie-info {
    padding: 0.4rem 0.5rem;
    font-size: 0.85rem;
    line-height: 1.1;
  }
  .movie-title {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .movie-year {
    color: #bbb;
  }
  .icon-row {
    position: absolute;
    top: 6px; right: 6px;
    display: flex; gap: 6px;
  }
  .icon {
    width: 18px; height: 18px;
    opacity: 0.75;
  }
  .icon.liked {
    filter: drop-shadow(0 0 1px #f39c12);
  }
  .icon.watched {
    filter: drop-shadow(0 0 1px #27ae60);
  }
  /* Expanded details modal */
  .modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: flex; justify-content: center; align-items: center;
    padding: 1rem;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.25s ease;
    z-index: 1000;
  }
  .modal.active {
    visibility: visible;
    opacity: 1;
  }
  .modal-content {
    background: #222;
    border-radius: 8px;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    padding: 1rem 1.25rem;
    position: relative;
    color: #eee;
  }
  .modal-close {
    position: absolute;
    top: 12px; right: 12px;
    background: transparent;
    border: none;
    color: #eee;
    font-size: 1.5rem;
    cursor: pointer;
  }
  .modal h2 {
    margin-top: 0;
  }
  .modal p {
    line-height: 1.4;
  }
  .modal-details {
    font-size: 0.9rem;
    color: #ccc;
    margin: 0.6rem 0 1rem;
  }
  .modal-trailer {
    width: 100%;
    aspect-ratio: 16/9;
    border: none;
    border-radius: 6px;
    margin-top: 1rem;
  }
  /* Dark mode toggle */
  .dark-toggle {
    display: flex; align-items: center; gap: 0.4rem;
    font-size: 0.9rem;
    cursor: pointer;
    user-select: none;
  }
  /* Responsive */
  @media (max-width: 700px) {
    .movie-card {
      width: 120px;
      height: auto;
    }
    .movie-poster {
      height: 180px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>My DVD Library</h1>
  <div class="controls">
    <input type="search" id="searchInput" placeholder="Search movies, actors, directors..." aria-label="Search movies"/>
    <button id="randomPickBtn" title="Pick a random movie or show">ðŸŽ² Random Pick</button>
    <label class="dark-toggle">
      <input type="checkbox" id="darkModeToggle" />
      Dark Mode
    </label>
  </div>
</header>

<main id="content">
  <p>Loading your collectionâ€¦</p>
</main>

<div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-content" role="document">
    <button aria-label="Close details" class="modal-close">&times;</button>
    <h2 id="modalTitle"></h2>
    <p id="modalDescription"></p>
    <p class="modal-details" id="modalDetails"></p>
    <iframe id="modalTrailer" class="modal-trailer" src="" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
  </div>
</div>

<script>
(async function() {
  // YOUR GOOGLE SHEET SETTINGS
  // Replace this with your sheet's published CSV link
  const GOOGLE_SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQp02iy9X1EC_W7jm12Ph3G9Z28WS1ndYJr6D-MS3CfeIBPkQiFbD9ZZj_mfOHxkZXFKEQNdmQoIhG3/pub?gid=0&single=true&output=csv';
  // NOTE: I converted your shared Google Sheet into a published CSV link for this demo.
  // You will need to Publish your Google Sheet as CSV via File > Publish to Web > CSV > Sheet1
  // and then replace the link above.

  const content = document.getElementById('content');
  const searchInput = document.getElementById('searchInput');
  const randomPickBtn = document.getElementById('randomPickBtn');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalDescription = document.getElementById('modalDescription');
  const modalDetails = document.getElementById('modalDetails');
  const modalTrailer = document.getElementById('modalTrailer');
  const modalCloseBtn = modal.querySelector('.modal-close');

  let movies = [];
  let filteredMovies = [];
  let lastShuffleDate = localStorage.getItem('lastShuffleDate') || null;
  let shuffledMovies = [];

  // Helper: parse CSV to array of objects
  function csvToObjects(csv) {
    const lines = csv.trim().split('\n');
    const headers = lines.shift().split(',');
    return lines.map(line => {
      const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
      let obj = {};
      headers.forEach((h, i) => obj[h] = values[i] || '');
      return obj;
    });
  }

  // Fetch CSV from Google Sheet
  async function fetchMovies() {
    const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQp02iy9X1EC_W7jm12Ph3G9Z28WS1ndYJr6D-MS3CfeIBPkQiFbD9ZZj_mfOHxkZXFKEQNdmQoIhG3/pub?gid=0&single=true&output=csv');
    const text = await res.text();
    return csvToObjects(text);
  }

  // Shuffle array helper
  function shuffleArray(arr) {
    let a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // Check if 24 hours passed since last shuffle
  function needsShuffle() {
    if (!lastShuffleDate) return true;
    const last = new Date(lastShuffleDate);
    const now = new Date();
    return (now - last) > 24 * 60 * 60 * 1000;
  }

  // Save shuffle date
  function saveShuffleDate() {
    localStorage.setItem('lastShuffleDate', new Date().toISOString());
  }

  // Filter movies by search and filters
  function filterMovies(query) {
    query = query.trim().toLowerCase();
    if (!query) return movies;

    return movies.filter(m => {
      // search title, director, actors, genre, description, collection title
      const haystack = [
        m.Title, m.Director_s, m.Main_Actor_s, m.Supporting_Actor_s,
        m.Genre_s, m.Description, m.DVD_Collection_Title, m.Writer_s
      ].join(' ').toLowerCase();

      return haystack.includes(query);
    });
  }

  // Group movies by genre (returns an object genre -> array of movies)
  function groupByGenre(movieList) {
    let groups = {};
    movieList.forEach(m => {
      if (!m.Genre_s) return;
      m.Genre_s.split(',').map(g => g.trim()).forEach(genre => {
        if (!groups[genre]) groups[genre] = [];
        groups[genre].push(m);
      });
    });
    return groups;
  }

  // Get recently watched movies (watched=yes, sort by Last Watched desc)
  function getRecentlyWatched(n=5) {
    return movies.filter(m => m.Watched_Yes_No.toLowerCase() === 'yes')
      .sort((a,b) => {
        let da = new Date(a.Last_Watched || 0);
        let db = new Date(b.Last_Watched || 0);
        return db - da;
      })
      .slice(0,n);
  }

  // Recommend movies based on genres, directors, actors in recent watches
  function getRecommendations() {
    const recent = getRecentlyWatched();
    if (!recent.length) return [];

    let genres = new Set();
    let directors = new Set();
    let actors = new Set();

    recent.forEach(m => {
      if(m.Genre_s) m.Genre_s.split(',').forEach(g => genres.add(g.trim()));
      if(m.Director_s) m.Director_s.split(',').forEach(d => directors.add(d.trim()));
      if(m.Main_Actor_s) m.Main_Actor_s.split(',').forEach(a => actors.add(a.trim()));
    });

    // Recommend movies matching any of these but NOT already watched
    return movies.filter(m => {
      if (m.Watched_Yes_No.toLowerCase() === 'yes') return false;
      const movieGenres = m.Genre_s ? m.Genre_s.split(',').map(x => x.trim()) : [];
      const movieDirectors = m.Director_s ? m.Director_s.split(',').map(x => x.trim()) : [];
      const movieActors = m.Main_Actor_s ? m.Main_Actor_s.split(',').map(x => x.trim()) : [];

      return movieGenres.some(g => genres.has(g)) ||
             movieDirectors.some(d => directors.has(d)) ||
             movieActors.some(a => actors.has(a));
    });
  }

  // Create a movie card DOM element
  function createMovieCard(movie) {
    const card = document.createElement('div');
    card.className = 'movie-card';
    card.setAttribute('tabindex', '0');
    card.setAttribute('role', 'button');
    card.setAttribute('aria-label', `View details for ${movie.Title}`);

    const poster = document.createElement('img');
    poster.className = 'movie-poster';
    poster.alt = `Cover art for ${movie.Title}`;
    poster.src = movie.Box_Art_Image_URL || '';
    poster.onerror = () => poster.src = 'https://via.placeholder.com/150x225?text=No+Image';

    const info = document.createElement('div');
    info.className = 'movie-info';

    const title = document.createElement('div');
    title.className = 'movie-title';
    title.textContent = movie.Title;

    const year = document.createElement('div');
    year.className = 'movie-year';
    year.textContent = movie.Year || '';

    const iconRow = document.createElement('div');
    iconRow.className = 'icon-row';

    if (movie.Liked_Yes_No && movie.Liked_Yes_No.toLowerCase() === 'yes') {
      const likedIcon = document.createElement('span');
      likedIcon.innerHTML = 'â­';
      likedIcon.title = 'Liked';
      likedIcon.className = 'icon liked';
      iconRow.appendChild(likedIcon);
    }
    if (movie.Watched_Yes_No && movie.Watched_Yes_No.toLowerCase() === 'yes') {
      const watchedIcon = document.createElement('span');
      watchedIcon.innerHTML = 'âœ”ï¸';
      watchedIcon.title = 'Watched';
      watchedIcon.className = 'icon watched';
      iconRow.appendChild(watchedIcon);
    }

    info.appendChild(title);
    info.appendChild(year);

    card.appendChild(poster);
    card.appendChild(iconRow);
    card.appendChild(info);

    // Click expands modal with details
    card.addEventListener('click', () => showModal(movie));
    card.addEventListener('keypress', (e) => { if(e.key === 'Enter') showModal(movie); });

    return card;
  }

  // Render a carousel row of movies
  function renderCarouselRow(title, movieList) {
    if (!movieList.length) return '';

    const container = document.createElement('section');
    const rowTitle = document.createElement('h2');
    rowTitle.className = 'row-title';
    rowTitle.textContent = title;
    container.appendChild(rowTitle);

    const carousel = document.createElement('div');
    carousel.className = 'carousel';

    movieList.forEach(movie => {
      carousel.appendChild(createMovieCard(movie));
    });

    container.appendChild(carousel);
    return container;
  }

  // Show modal with movie details
  function showModal(movie) {
    modalTitle.textContent = movie.Title;
    modalDescription.textContent = movie.Description || 'No description available.';
    modalDetails.textContent = `
      Year: ${movie.Year || 'Unknown'} | Runtime: ${movie['Runtime (min)'] || 'N/A'} min
      ${movie.Director_s ? '| Director(s): ' + movie.Director_s : ''}
      ${movie.Main_Actor_s ? '| Actors: ' + movie.Main_Actor_s : ''}
      ${movie.DVD_Collection_Title ? '| DVD Collection: ' + movie.DVD_Collection_Title : ''}
    `.replace(/\| $/, '').trim();

    if (movie['YouTube Trailer URL']) {
      // Extract embed link from YouTube URL
      const url = movie['YouTube Trailer URL'];
      let videoId = null;
      // Supports youtu.be and youtube.com URLs
      const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([\w-]+)/);
      if (ytMatch) videoId = ytMatch[1];
      if (videoId) {
        modalTrailer.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
        modalTrailer.style.display = 'block';
      } else {
        modalTrailer.style.display = 'none';
      }
    } else {
      modalTrailer.style.display = 'none';
      modalTrailer.src = '';
    }

    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
  }

  // Close modal
  modalCloseBtn.addEventListener('click', () => {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    modalTrailer.src = '';
  });

  // Close modal on background click
  modal.addEventListener('click', e => {
    if (e.target === modal) {
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
      modalTrailer.src = '';
    }
  });

  // Dark mode toggle
  darkModeToggle.addEventListener('change', e => {
    if (e.target.checked) {
      document.body.style.background = '#121212';
      document.body.style.color = '#eee';
    } else {
      document.body.style.background = '#f5f5f5';
      document.body.style.color = '#222';
    }
  });

  // Random pick button
  randomPickBtn.addEventListener('click', () => {
    if (!movies.length) return;
    const available = movies.filter(m => m.Watched_Yes_No?.toLowerCase() !== 'yes');
    const pickPool = available.length ? available : movies;
    const pick = pickPool[Math.floor(Math.random() * pickPool.length)];
    showModal(pick);
  });

  // Search input handler
  searchInput.addEventListener('input', () => {
    const q = searchInput.value;
    filteredMovies = filterMovies(q);
    renderAllRows(filteredMovies);
  });

  // Render all rows with optional filtered movies
  function renderAllRows(data) {
    content.innerHTML = '';

    // Recommended row
    const recommended = getRecommendations();
    if (recommended.length) content.appendChild(renderCarouselRow('Recommended For You', recommended));

    // Group by genre and render shuffled rows
    const grouped = groupByGenre(data);
    const genres = Object.keys(grouped).sort();

    genres.forEach(genre => {
      // Shuffle order of movies within genre daily
      let moviesForGenre = grouped[genre].slice();
      if (needsShuffle()) {
        moviesForGenre = shuffleArray(moviesForGenre);
      }
      content.appendChild(renderCarouselRow(genre, moviesForGenre));
    });

    // ALL movies row alphabetical
    const allRowMovies = data.slice().sort((a,b) => a.Title.localeCompare(b.Title));
    content.appendChild(renderCarouselRow('All Movies & Shows', allRowMovies));

    // Save shuffle date
    if (needsShuffle()) saveShuffleDate();
  }

  // Main init
  try {
    movies = await fetchMovies();

    // Normalize keys to safe JS property names by replacing spaces and parentheses with underscores
    movies = movies.map(m => {
      const norm = {};
      Object.entries(m).forEach(([k,v]) => {
        const key = k.trim().replace(/[ ()]/g,'_');
        norm[key] = v;
      });
      return norm;
    });

    filteredMovies = movies.slice();
    renderAllRows(filteredMovies);

  } catch (e) {
    content.innerHTML = `<p>Failed to load your collection. Check your Google Sheet settings and link.</p>`;
    console.error(e);
  }
})();
</script>

</body>
</html>
